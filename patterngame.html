<!DOCTYPE html>
<html>

<head>
  <meta content="text/html; charset=utf-8" http-equiv="content-type">
  <meta name="viewport"
    content="width=540, initial-scale=0.6, maximum-scale=0.8, minimum-scale=0.3, user-scalable=yes" />

  <title>Pattern game</title>
  <meta content="Tarmo Johannes" id="author">

  <!-- <link type="text/css" rel="stylesheet" href="soundgames.css"> -->
  <!-- Vuetify CSS -->
  <link href="https://cdn.jsdelivr.net/npm/vuetify@3.8.0/dist/vuetify.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/@mdi/font/css/materialdesignicons.min.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700&display=swap">

  <script src="ws-functions.js"></script> <!-- websocket functions -->
  <script defer="defer" src="patterngame-ui.js">	</script>

  <!-- Vue.js -->
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

  <!-- Vuetify JS -->
  <script src="https://cdn.jsdelivr.net/npm/vuetify@3.8.0/dist/vuetify.min.js"></script>

</head>

<body>

  <div id="app">
    <v-app>
      <v-container class="text-center">
        <h1>Pattern Game</h1>
      </v-container>

      <v-container v-show="!audioLoaded">
        <p>Click the button below to initialize audio.</p>
        <v-btn @click="proxyInitAudio" v-show="!audioLoaded" color="primary">Start</v-btn>
        <!-- <v-alert v-model="audioLoaded" type="success" timeout="3000">Audio successfully loaded!</v-alert> -->

      </v-container>

      <v-container id="mainContainer" v-show="audioLoaded">

        <v-container id="matrix">
          <div class="button-grid">
            <div v-for="rowIndex in numberOfNotes" :key="rowIndex" class="grid-row">
              <v-btn v-for="colIndex in numberOfNotes" :key="colIndex"
                :color="buttonMatrix[rowIndex - 1][colIndex - 1] ? 'success' : 'grey'"
                @click="toggleButton(rowIndex - 1, colIndex - 1)" class="rounded-square" elevation="2"></v-btn>
            </div>
          </div>
          </v-row>

        </v-container>

        <v-container id="controls">
          <v-select style="width: 300px;" v-model="selectedMode" :items="modes" label="Select a scale"
            item-value="value" item-title="title" @update:model-value="setMode" outlined>
          </v-select>

          <v-radio-group inline v-model="voice" label="Octave/Range">
            <v-radio label="Low" value="0"></v-radio>
            <v-radio label="Middle" value="1"></v-radio>
            <v-radio label="High" value="2"></v-radio>
          </v-radio-group>
          <v-row>
            Repeat the melody
            <v-col cols="auto">
              <v-number-input v-model="repeatCount" :min="1" :max="4" :step="1"></v-number-input>
            </v-col>
            times,
          </v-row>
          <v-row align="center" justify="start">
            <span>after</span>
            <v-col cols="auto">
              <v-number-input v-model="delay" :min="2" :max="10" :step="1"></v-number-input>
              <span> units (square durations).</span>
            </v-col>
          </v-row>

        </v-container>



    </v-app>


  </div>

  <script>
    const { createApp, ref, watch } = Vue;
    const { createVuetify } = Vuetify;

    const vuetify = createVuetify({
      theme: {
        defaultTheme: 'dark', // Set the default theme to dark
      },
    });


    createApp({
      setup() {
        // properties -----------------
        const message = ref('Pattern Game')
        const audioLoaded = ref(false);

        const numberOfNotes = ref(5); // Default number of notes
        const buttonMatrix = ref(
          Array.from({ length: numberOfNotes.value }, () =>
            Array.from({ length: numberOfNotes.value }, () => false)
          )
        );

        const selectedMode = ref(0); // Default selected mode
        const modes = ref([
          { value: 0, title: "(Pseudo) slendro (5 steps)" },
          { value: 1, title: "Harrison's pelog (7 steps)" },
          { value: 2, title: "Bohlen-Pierce justtone (9 steps)" },
        ]);

        const voice = ref("1");
        const repeatCount = ref(1);
        const delay = ref(4);

        // methods ------------------

        const setMode = (value) => {
          console.log("Selected mode:", value);
          setModeData(value);
          selectedMode.value = value;
          numberOfNotes.value = MAX_NOTES;
          // Here you can add logic to handle the mode change


        };

        const toggleButton = (row, col) => {
          console.log(`Toggling button at row ${row}, col ${col}`);
          for (let i = 0; i < numberOfNotes.value; i++) {
            if (i !== row && buttonMatrix.value[i][col]) {
              buttonMatrix.value[i][col] = false; // Turn off other buttons in the column
            }
          }
          buttonMatrix.value[row][col] = !buttonMatrix.value[row][col];
          if (buttonMatrix.value[row][col]) {
            //oscil.playSound(baseFrequency * steps[this.getAttr("pitch_index")] * (1 << voice), 0, 0.75);
            const step = numberOfNotes.value - row - 1; // Invert row index for sound frequency
            oscil.playSound(baseFrequency * steps[step] * (1 << parseInt(voice.value)), 0, 0.75);
          }
        };

        const proxyInitAudio = () => {
          if (!audioLoaded.value) {
            initAudio();
            audioLoaded.value = true;
            message.value = 'Audio initialized!';
          } else {
            message.value = 'Audio already initialized.';
          }
        };


        // Watch for changes to numberOfNotes and update buttonMatrix
        watch(numberOfNotes, (newValue) => {
          buttonMatrix.value = Array.from({ length: newValue }, () =>
            Array.from({ length: newValue }, () => false)
          );
        });


        return {
          numberOfNotes, audioLoaded, proxyInitAudio,
          buttonMatrix,
          selectedMode,
          modes,
          setMode,
          toggleButton,
          voice,
          repeatCount, delay
        };
      }

    }).use(vuetify).mount("#app");

  </script>

  <style>
    .button-grid {
      display: flex;
      flex-direction: column;
      /* Stack rows vertically */
      gap: 5px;
      /* Space between rows */
      width: 100%;
      /* Full width of the container */
    }

    .grid-row {
      display: flex;
      gap: 5px;
      /* Space between buttons in a row */
      justify-content: center;
      /* Center buttons horizontally */
    }

    .rounded-square {
      aspect-ratio: 1 / 1;
      /* Ensure buttons are square */
      width: calc(100% / var(--number-of-notes));
      /* Dynamic width based on number of notes */
      height: auto;
      /* Automatically adjust height to match width */
      border-radius: 8px;
      /* Rounded corners */
    }

    .v-btn {
      min-width: 0 !important;
      /* Override Vuetify's default min-width */
    }
  </style>





</body>

</html>